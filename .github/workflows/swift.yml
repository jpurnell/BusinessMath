name: CI

on:
  push:
    branches: [ main ]
  pull_request:
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read

jobs:
  tests:
    name: Tests (${{ matrix.engine }})
    runs-on: macos-15
    strategy:
      fail-fast: false
      matrix:
        engine: [swift-testing]
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Select Xcode 16.x (Swift 6)
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: '16.4'

      - name: Tooling versions
        run: |
          xcodebuild -version
          swift --version

      - name: Select test engine and scratch path
        run: |
          if [ "${{ matrix.engine }}" = "swift-testing" ]; then
            echo "SWIFT_TEST_FLAGS=--enable-swift-testing" >> $GITHUB_ENV
            echo "SCRATCH=.build-swift-testing" >> $GITHUB_ENV
          else
            echo "SWIFT_TEST_FLAGS=" >> $GITHUB_ENV
            echo "SCRATCH=.build-xctest" >> $GITHUB_ENV
          fi

      - name: Build + Test (Debug and Release)
        run: |
          set -euo pipefail

          # If this is the Swift Testing leg, skip cleanly when there are no @Test tests
          if [ "${{ matrix.engine }}" = "swift-testing" ]; then
            if ! swift test --enable-swift-testing --list-tests --scratch-path "$SCRATCH" | grep -q .; then
              echo "No Swift Testing (@Test) tests found; skipping swift-testing leg."
              exit 0
            fi
          else
            swift test --list-tests --scratch-path "$SCRATCH" || true
          fi

          # Debug build + tests
          swift build --build-tests $SWIFT_TEST_FLAGS --scratch-path "$SCRATCH" -v
          swift test  $SWIFT_TEST_FLAGS --parallel --scratch-path "$SCRATCH" -v

          # Release tests (optimizer-on)
          swift test -c release $SWIFT_TEST_FLAGS --parallel --scratch-path "$SCRATCH" -v

  build_and_compile:
    name: Release build + Apple platform compile checks
    needs: tests
    if: always()
    runs-on: macos-15
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Select Xcode 16.x (Swift 6)
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: '16.4'

      - name: Tooling versions
        run: |
          xcodebuild -version
          swift --version

      - name: Release build (SPM)
        run: swift build -c release

      - name: Prepare ephemeral Xcode workspace
        shell: bash
        run: |
          set -euo pipefail
          PKG_SCHEME="BusinessMath-Package"
          # Force generation of the ephemeral workspace for the package
          xcodebuild -scheme "$PKG_SCHEME" -resolvePackageDependencies -quiet || true
          # Belt-and-suspenders: query build settings to ensure workspace is materialized
          xcodebuild -scheme "$PKG_SCHEME" -showBuildSettings >/dev/null
          ls -la .swiftpm/xcode || true

      - name: macOS build for MCP executable (workspace)
        shell: bash
        run: |
          set -euo pipefail
          WORKSPACE=".swiftpm/xcode/package.xcworkspace"
          SCHEME_MCP="businessmath-mcp-server"
          # Build the MCP executable only on macOS
          xcodebuild -workspace "$WORKSPACE" \
            -scheme "$SCHEME_MCP" \
            -destination "generic/platform=macOS" \
            -configuration Release \
            -skipPackagePluginValidation \
            build

      - name: Apple platform compile checks (BusinessMath only, workspace)
        shell: bash
        run: |
          set -euo pipefail
          WORKSPACE=".swiftpm/xcode/package.xcworkspace"

          # Find a library-only scheme for BusinessMath
          SCHEME_LIB="BusinessMath"
          if ! xcodebuild -list -workspace "$WORKSPACE" | sed -n '/Schemes:/,/Targets:/p' | grep -qx "    $SCHEME_LIB"; then
            # Fallback: some setups name the product scheme "<Package>-<Product>"
            SCHEME_LIB="BusinessMath-BusinessMath"
          fi
          echo "Using BusinessMath scheme: $SCHEME_LIB"
          xcodebuild -list -workspace "$WORKSPACE" || true

          # Build BusinessMath for the Apple platforms (no MCP pulled in)
          for plat in iOS tvOS watchOS; do
            echo "Building $SCHEME_LIB for $plat"
            xcodebuild -workspace "$WORKSPACE" \
              -scheme "$SCHEME_LIB" \
              -destination "generic/platform=${plat}" \
              -configuration Release \
              -skipPackagePluginValidation \
              build
          done

          if xcodebuild -showsdks | grep -q "visionOS"; then
            echo "Building $SCHEME_LIB for visionOS"
            xcodebuild -workspace "$WORKSPACE" \
              -scheme "$SCHEME_LIB" \
              -destination "generic/platform=visionOS" \
              -configuration Release \
              -skipPackagePluginValidation \
              build
          fi
