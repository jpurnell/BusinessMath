name: CI

on:
  push:
    branches: [ main ]
  pull_request:
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read

jobs:
  tests:
    name: Tests (${{ matrix.engine }})
    runs-on: macos-15
    strategy:
      fail-fast: false
      matrix:
        engine: [swift-testing]
    env:
      PACKAGE_NAME: BusinessMath
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Select Xcode 16.x (Swift 6)
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: '16.4'  # or '16' for latest 16.x on the image

      - name: Tooling versions
        run: |
          xcodebuild -version
          swift --version

      - name: Select test engine and scratch path
        run: |
          if [ "${{ matrix.engine }}" = "swift-testing" ]; then
            echo "SWIFT_TEST_FLAGS=--enable-swift-testing" >> $GITHUB_ENV
            echo "SCRATCH=.build-swift-testing" >> $GITHUB_ENV
          else
            echo "SWIFT_TEST_FLAGS=" >> $GITHUB_ENV
            echo "SCRATCH=.build-xctest" >> $GITHUB_ENV
          fi

      - name: Build + Test (Debug and Release)
        run: |
          set -euo pipefail

          # If this is the Swift Testing leg, skip cleanly when there are no @Test tests
          if [ "${{ matrix.engine }}" = "swift-testing" ]; then
            if ! swift test --enable-swift-testing --list-tests --scratch-path "$SCRATCH" | grep -q .; then
              echo "No Swift Testing (@Test) tests found; skipping swift-testing leg."
              exit 0
            fi
          else
            swift test --list-tests --scratch-path "$SCRATCH" || true
          fi

          # Debug build + tests
          swift build --build-tests $SWIFT_TEST_FLAGS --scratch-path "$SCRATCH" -v
          swift test  $SWIFT_TEST_FLAGS --parallel --scratch-path "$SCRATCH" -v

          # Release tests (optimizer-on)
          swift test -c release $SWIFT_TEST_FLAGS --parallel --scratch-path "$SCRATCH" -v

    build_and_compile:
      name: Release build + Apple platform compile checks
      needs: tests
      if: always()
      runs-on: macos-15
      env:
        PACKAGE_NAME: BusinessMath
      steps:
        - name: Checkout
          uses: actions/checkout@v4

        - name: Select Xcode 16.x (Swift 6)
          uses: maxim-lobanov/setup-xcode@v1
          with:
            xcode-version: '16.4'

        - name: Tooling versions
          run: |
            xcodebuild -version
            swift --version

        - name: Release build (SPM)
          run: swift build -c release

        # Build only the MCP server for macOS (from manifest)
        - name: macOS build for MCP executable
          shell: bash
          run: |
            set -euo pipefail
            xcodebuild -onlyUsePackageManifest  -target businessmath-mcp-server  -destination "generic/platform=macOS"  -configuration Release  -skipPackagePluginValidation  build

        # Build only the BusinessMath library target for other Apple platforms (from manifest)
        - name: Apple platform compile checks (Xcode, from manifest)
          shell: bash
          run: |
            set -euo pipefail
            xcodebuild -onlyUsePackageManifest  -target BusinessMath  -destination "generic/platform=iOS"  -configuration Release  -skipPackagePluginValidation  build
            xcodebuild -onlyUsePackageManifest  -target BusinessMath  -destination "generic/platform=tvOS"  -configuration Release  -skipPackagePluginValidation  build
            xcodebuild -onlyUsePackageManifest  -target BusinessMath  -destination "generic/platform=watchOS"  -configuration Release  -skipPackagePluginValidation  build

            if xcodebuild -showsdks | grep -q "visionOS"; then
              xcodebuild -onlyUsePackageManifest    -target BusinessMath    -destination "generic/platform=visionOS"    -configuration Release    -skipPackagePluginValidation    build
            fi
