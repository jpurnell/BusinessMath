name: CI

on:
  push:
    branches: [ main ]
  pull_request:
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read

jobs:
  tests:
    name: Tests (${{ matrix.engine }})
    runs-on: macos-15
    strategy:
      fail-fast: false
      matrix:
        engine: [swift-testing]
    env:
      PACKAGE_NAME: BusinessMath
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Select Xcode 16.x (Swift 6)
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: '16.4'  # or '16' for latest 16.x on the image

      - name: Tooling versions
        run: |
          xcodebuild -version
          swift --version

      - name: Select test engine and scratch path
        run: |
          if [ "${{ matrix.engine }}" = "swift-testing" ]; then
            echo "SWIFT_TEST_FLAGS=--enable-swift-testing" >> $GITHUB_ENV
            echo "SCRATCH=.build-swift-testing" >> $GITHUB_ENV
          else
            echo "SWIFT_TEST_FLAGS=" >> $GITHUB_ENV
            echo "SCRATCH=.build-xctest" >> $GITHUB_ENV
          fi

      - name: Build + Test (Debug and Release)
        run: |
          set -euo pipefail

          # If this is the Swift Testing leg, skip cleanly when there are no @Test tests
          if [ "${{ matrix.engine }}" = "swift-testing" ]; then
            if ! swift test --enable-swift-testing --list-tests --scratch-path "$SCRATCH" | grep -q .; then
              echo "No Swift Testing (@Test) tests found; skipping swift-testing leg."
              exit 0
            fi
          else
            swift test --list-tests --scratch-path "$SCRATCH" || true
          fi

          # Debug build + tests
          swift build --build-tests $SWIFT_TEST_FLAGS --scratch-path "$SCRATCH" -v
          swift test  $SWIFT_TEST_FLAGS --parallel --scratch-path "$SCRATCH" -v

          # Release tests (optimizer-on)
          swift test -c release $SWIFT_TEST_FLAGS --parallel --scratch-path "$SCRATCH" -v

  build_and_compile:
    name: Release build + Apple platform compile checks
    needs: tests
    if: always()
    runs-on: macos-15
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Select Xcode 16.x (Swift 6)
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: '16.4'

      - name: Tooling versions
        run: |
          xcodebuild -version
          swift --version

      - name: Release build (SPM)
        run: swift build -c release

      - name: Prepare ephemeral Xcode artifacts
        shell: bash
        run: |
          set -euo pipefail
          # Force generation of the ephemeral workspace/project for the package
          xcodebuild -scheme "BusinessMath-Package" -resolvePackageDependencies -quiet || true
          # Sanity-check they exist
          ls -la .swiftpm/xcode || true
          xcodebuild -list -workspace ".swiftpm/xcode/package.xcworkspace" || true
          xcodebuild -list -project ".swiftpm/xcode/package.xcodeproj" || true

      - name: macOS build for MCP executable (project/target)
        shell: bash
        run: |
          set -euo pipefail
          PROJ=".swiftpm/xcode/package.xcodeproj"
          xcodebuild -project "$PROJ" \
            -target businessmath-mcp-server \
            -destination "generic/platform=macOS" \
            -configuration Release \
            -skipPackagePluginValidation \
            build

      - name: Apple platform compile checks (BusinessMath only; project/target)
        shell: bash
        run: |
          set -euo pipefail
          PROJ=".swiftpm/xcode/package.xcodeproj"
          for plat in iOS tvOS watchOS; do
            echo "Building BusinessMath target for $plat"
            xcodebuild -project "$PROJ" \
              -target BusinessMath \
              -destination "generic/platform=${plat}" \
              -configuration Release \
              -skipPackagePluginValidation \
              build
          done

          if xcodebuild -showsdks | grep -q "visionOS"; then
            echo "Building BusinessMath target for visionOS"
            xcodebuild -project "$PROJ" \
              -target BusinessMath \
              -destination "generic/platform=visionOS" \
              -configuration Release \
              -skipPackagePluginValidation \
              build
          fi
