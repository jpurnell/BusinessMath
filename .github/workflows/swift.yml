name: CI

on:
  push:
    branches: [ main ]
  pull_request:
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read

jobs:
  macos:
    name: macOS (SPM + Apple platform compile checks)
    runs-on: macos-15
    strategy:
      fail-fast: false
      matrix:
        engine: [xctest, swift-testing]
    env:
      PACKAGE_NAME: BusinessMath
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Select Xcode 16.x (Swift 6)
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: '16.4'  # or '16' to pick the latest 16.x

      - name: Tooling versions
        run: |
          xcodebuild -version
          swift --version

      - name: Capture Xcode version for cache key
        run: echo "XCODE_VER=$(xcodebuild -version | tr '\n' ' ')" >> $GITHUB_ENV

      - name: Select test engine and scratch path
        run: |
          if [ "${{ matrix.engine }}" = "swift-testing" ]; then
            echo "SWIFT_TEST_FLAGS=--enable-swift-testing" >> $GITHUB_ENV
            echo "SCRATCH=.build-swift-testing" >> $GITHUB_ENV
          else
            echo "SWIFT_TEST_FLAGS=" >> $GITHUB_ENV
            echo "SCRATCH=.build-xctest" >> $GITHUB_ENV
          fi

      - name: Compute SPM dependency hash
        id: deps
        shell: bash
        run: |
          set -euo pipefail
          if [ -f Package.resolved ]; then
            H=$(shasum -a 256 Package.resolved | cut -d' ' -f1)
          else
            H=$(shasum -a 256 Package.swift | cut -d' ' -f1)
          fi
          echo "SPM_DEP_HASH=$H" >> "$GITHUB_ENV"

      - name: Cache SPM build products (per engine)
        uses: actions/cache@v4
        with:
          path: ${{ env.SCRATCH }}
          key: ${{ runner.os }}-spm-${{ env.XCODE_VER }}-${{ matrix.engine }}-${{ env.SPM_DEP_HASH }}
          restore-keys: |
            ${{ runner.os }}-spm-${{ env.XCODE_VER }}-${{ matrix.engine }}-
            ${{ runner.os }}-spm-${{ env.XCODE_VER }}-
            ${{ runner.os }}-spm-

      - name: Build (Debug) + tests (macOS, ${{ matrix.engine }})
        run: |
          set -o pipefail

          swift build --build-tests $SWIFT_TEST_FLAGS --scratch-path "$SCRATCH" --jobs 1 -v
          swift test $SWIFT_TEST_FLAGS --scratch-path "$SCRATCH" --jobs 1 -v

          LOG_D="build-${{ matrix.engine }}-debug.log"
          LOG_R="build-${{ matrix.engine }}-release.log"

          if ! swift build --build-tests $SWIFT_TEST_FLAGS --scratch-path "$SCRATCH" -v 2>&1 | tee "$LOG_D"; then
            echo "===== tail of $LOG_D ====="; tail -n 200 "$LOG_D"; exit 1; fi

          if ! swift test $SWIFT_TEST_FLAGS --parallel --scratch-path "$SCRATCH" -v 2>&1 | tee -a "$LOG_D"; then
            echo "===== tail of $LOG_D ====="; tail -n 200 "$LOG_D"; exit 1; fi

          if ! swift test -c release $SWIFT_TEST_FLAGS --parallel --scratch-path "$SCRATCH" -v 2>&1 | tee "$LOG_R"; then
            echo "===== tail of $LOG_R ====="; tail -n 200 "$LOG_R"; exit 1; fi
            
          swift build --build-tests $SWIFT_TEST_FLAGS --scratch-path "$SCRATCH" -v 2>&1 | tee build-${{ matrix.engine }}-debug.log
          swift test  $SWIFT_TEST_FLAGS --parallel --scratch-path "$SCRATCH" -v 2>&1 | tee -a build-${{ matrix.engine }}-debug.log
          swift test  -c release $SWIFT_TEST_FLAGS --parallel --scratch-path "$SCRATCH" -v 2>&1 | tee build-${{ matrix.engine }}-release.log

      - name: Upload build logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: logs-${{ matrix.engine }}
          path: |
            build-${{ matrix.engine }}-debug.log
            build-${{ matrix.engine }}-release.log

      - name: Build library in Release (macOS)
        if: matrix.engine == 'xctest'
        run: swift build -c release --scratch-path "$SCRATCH"

      - name: Compile checks for Apple platforms with Xcode
        if: matrix.engine == 'xctest'
        shell: bash
        run: |
          set -euo pipefail
          SCHEME="${PACKAGE_NAME}-Package"
          xcodebuild -scheme "$SCHEME" -destination "generic/platform=iOS"     -configuration Release -skipPackagePluginValidation build
          xcodebuild -scheme "$SCHEME" -destination "generic/platform=tvOS"    -configuration Release -skipPackagePluginValidation build
          xcodebuild -scheme "$SCHEME" -destination "generic/platform=watchOS" -configuration Release -skipPackagePluginValidation build
          if xcodebuild -showsdks | grep -q "visionOS"; then
            xcodebuild -scheme "$SCHEME" -destination "generic/platform=visionOS" -configuration Release -skipPackagePluginValidation build
          fi
